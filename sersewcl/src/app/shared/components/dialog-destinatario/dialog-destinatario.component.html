<!--
 * @license
 *
 * Copyright © 2025 Regione Piemonte
 *
 * Licensed under the EUPL, Version 1.2 or – as soon they will be
 * approved by the European Commission - subsequent versions of the
 * EUPL (the "Licence");
 *
 * You may not use this work except in compliance with the Licence.
 * You may obtain a copy of the Licence at:
 *
 * https://interoperable-europe.ec.europa.eu/collection/eupl/eupl-text-eupl-12
 * or
 * https://opensource.org/license/EUPL-1.2
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the Licence is distributed on an "AS IS" basis,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the Licence for the specific language governing permissions and
 * limitations under the Licence.
 -->

<h2 mat-dialog-title>Nuovo destinatario</h2>
<mat-divider></mat-divider>
<mat-dialog-content #scrollContainer>
<div class="ps-3 pe-3">
<!-- ############################## -->
<form [formGroup]="form">

<div class="row justify-content-center" #errori>
  <div class="col-auto">
    <mat-error>{{errorNonCompilati}}</mat-error>
    <mat-error>{{errorRecapiti}}</mat-error>
  </div>
</div>
<!-- ---------------------------------------------------------------------------- -->
<!-- ---------------------------Anagrafica--------------------------------------- -->
<form [formGroup]="anagrafica">
<div class="row">
<!-- Cognome -->
<div class="col-md-6 col-sm-12">
  <mat-form-field class="w-100" appearance="legacy">
    <mat-label>Cognome*</mat-label>
    <input matInput formControlName="cognome" maxlength="100" style="text-transform:uppercase">
    <mat-error>
      <app-control-messages [control]="anagrafica.controls['cognome']"></app-control-messages>
    </mat-error>
  </mat-form-field>
</div>
<!-- Nome -->
<div class="col-md-6 col-sm-12">
  <mat-form-field class="w-100" appearance="legacy">
    <mat-label>Nome*</mat-label>
    <input matInput formControlName="nome" maxlength="100" style="text-transform:uppercase">
    <mat-error>
      <app-control-messages [control]="anagrafica.controls['nome']"></app-control-messages>
    </mat-error>
  </mat-form-field>
</div>
<!-- codice fiscale -->
<div class="col-md-6 col-sm-12">
  <mat-form-field class="w-100" appearance="legacy">
    <mat-label>Codice fiscale</mat-label>
    <input matInput formControlName="codFisc" maxlength="16" style="text-transform:uppercase">
    <mat-error>
      <app-control-messages [control]="anagrafica.controls['codFisc']"></app-control-messages>
    </mat-error>
  </mat-form-field>
</div>
<!-- Data di nascia -->
<div class="col-md-6 col-sm-12">
  <mat-form-field appearance="legacy">
    <mat-label>Data di nascita</mat-label>
    <input matInput [matDatepickerFilter]="myFilter" [matDatepicker]="picker" formControlName="dataNascita">
    <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
    <mat-datepicker #picker></mat-datepicker>
    <mat-error>
      <app-control-messages [control]="anagrafica.controls['dataNascita']"></app-control-messages>
    </mat-error>
  </mat-form-field>
</div>
</div>
</form>

<!-- Luogo di nascita -->
<div class="mt-2">
  <label class="me-3">Luogo di nascita: </label>
  <mat-radio-group formControlName="luogoNascita">
    <mat-radio-button class="me-2" value="1">Italia</mat-radio-button>
    <mat-radio-button value="2">Estero</mat-radio-button>
  </mat-radio-group>
</div>

<ng-container *ngIf="form.controls['luogoNascita'].value == '1'; else nascitaEstero">
<form [formGroup]="natalitaItaliana" class="row">
<!-- Provincia -->
<div class="col-md-6 col-sm-12">
  <mat-form-field class="w-100" appearance="legacy">
    <mat-label>Selezionare Provincia di nascita </mat-label>
    <mat-select formControlName="provincia" (selectionChange)="fetchComuniNascita(natalitaItaliana.controls['provincia'].value!)">
      <mat-option>-- None --</mat-option>
      <mat-option *ngFor="let provincia of provincieList" [value]="provincia.codiceProvincia">{{provincia.descrizione}}</mat-option>
    </mat-select>
    <mat-error>
      <app-control-messages [control]="natalitaItaliana.controls['provincia']"></app-control-messages>
    </mat-error>
  </mat-form-field>
</div>
<!-- Comune -->
<div class="col-md-6 col-sm-12">
  <mat-form-field class="w-100" appearance="legacy">
    <mat-label>Selezionare Comune di nascita </mat-label>
    <mat-select formControlName="comune">
      <mat-option>-- None --</mat-option>
      <mat-option *ngFor="let comune of comuniNascitaList" [value]="comune.codiceIstatComune">{{comune.descrizione}}</mat-option>
    </mat-select>
    <mat-error>
      <app-control-messages [control]="natalitaItaliana.controls['comune']"></app-control-messages>
    </mat-error>
  </mat-form-field>
</div>
</form>
</ng-container>

<ng-template #nascitaEstero>
<form [formGroup]="natalitaEstero" class="row">
<!-- Stato -->
<div class="col-md-6 col-sm-12">
  <mat-form-field class="w-100" appearance="legacy">
    <mat-label>Selezionare Stato estero di nascita </mat-label>
    <mat-select formControlName="stato">
      <mat-option>-- None --</mat-option>
      <mat-option *ngFor="let statoEstero of statiEsteriList" [value]="statoEstero.codStato?.toString()">{{statoEstero.decrizioneStato}}</mat-option>
    </mat-select>
    <mat-error>
      <app-control-messages [control]="natalitaEstero.controls['stato']"></app-control-messages>
    </mat-error>
  </mat-form-field>
</div>
<!-- Citta -->
<div class="col-md-6 col-sm-12">
  <mat-form-field class="w-100" appearance="legacy">
    <mat-label>Citta di nascita</mat-label>
    <input matInput formControlName="citta" maxlength="100" style="text-transform:uppercase">
    <mat-error>
      <app-control-messages [control]="natalitaEstero.controls['citta']"></app-control-messages>
    </mat-error>
  </mat-form-field>
</div>
</form>
</ng-template>

<div class="row">
  <!-- Cittadinanza -->
  <div class="col-md-6 col-sm-12">
    <mat-form-field class="w-100" appearance="legacy">
      <mat-label>Selezionare la cittadinanza </mat-label>
      <mat-select formControlName="cittadinanza">
        <mat-option>-- None --</mat-option>
        <mat-option *ngFor="let cittadinanza of cittadinanzeList" [value]="cittadinanza.codiceCittadinanza">{{cittadinanza.descrizione}}</mat-option>
      </mat-select>
      <mat-error>
        <app-control-messages [control]="form.controls['cittadinanza']"></app-control-messages>
      </mat-error>
    </mat-form-field>
  </div>
</div>

<!-- ---------------------------------------------------------------------------- -->
<!-- ---------------------------Residenza--------------------------------------- -->
<hr>
<h5 mat-dialog-title>Residenza</h5>
<div class="">
  <label class="me-3">Luogo di residenza: </label>
  <mat-radio-group formControlName="luogoResidenza">
    <mat-radio-button class="me-2" value="1">Italia</mat-radio-button>
    <mat-radio-button value="2">Estero</mat-radio-button>
  </mat-radio-group>
</div>

<ng-container *ngIf="form.controls['luogoResidenza'].value == '1'; else residenzaEsterno">
<form [formGroup]="residenzaItaliana" class="row">
     <!-- Provincia -->
  <div class="col-md-6 col-sm-12">
    <mat-form-field class="w-100" appearance="legacy">
      <mat-label>Selezionare Provincia di residenza </mat-label>
      <mat-select formControlName="provinciaResidenza" (selectionChange)="fetchComuniResidenza(residenzaItaliana.controls['provinciaResidenza'].value!)">
        <mat-option>-- None --</mat-option>
        <mat-option *ngFor="let provincia of provincieList" [value]="provincia.codiceProvincia">{{provincia.descrizione}}</mat-option>
      </mat-select>
      <mat-error>
        <app-control-messages [control]="residenzaItaliana.controls['provinciaResidenza']"></app-control-messages>
      </mat-error>
    </mat-form-field>
  </div>
  <!-- Comune -->
  <div class="col-md-6 col-sm-12">
    <mat-form-field class="w-100" appearance="legacy">
      <mat-label>Selezionare Comune di residenza </mat-label>
      <mat-select formControlName="comuneResidenza">
        <mat-option>-- None --</mat-option>
        <mat-option *ngFor="let comune of comuniResidenzaList" [value]="comune.codiceIstatComune">{{comune.descrizione}}</mat-option>
      </mat-select>
      <mat-error>
        <app-control-messages [control]="residenzaItaliana.controls['comuneResidenza']"></app-control-messages>
      </mat-error>
    </mat-form-field>
  </div>
  <!-- Indirizzo -->
  <div class="col-10">
    <mat-form-field class="w-100" appearance="legacy">
      <mat-label>Indirizzo</mat-label>
      <input matInput formControlName="indirizzoResidenza" maxlength="100" style="text-transform:uppercase">
      <mat-error>
        <app-control-messages [control]="residenzaItaliana.controls['indirizzoResidenza']"></app-control-messages>
      </mat-error>
    </mat-form-field>
  </div>
  <!-- Cap -->
  <div class="col-2">
    <mat-form-field class="w-100" appearance="legacy">
      <mat-label>CAP</mat-label>
      <input matInput formControlName="capResidenza" [textMask]="{mask:capMask, guide:false}">
      <mat-error>
        <app-control-messages [control]="residenzaItaliana.controls['capResidenza']"></app-control-messages>
      </mat-error>
    </mat-form-field>
  </div>
</form>
</ng-container>

<ng-template #residenzaEsterno>
<form [formGroup]="residenzaEstera" class="row">
<!-- Stato -->
<div class="col-md-6 col-sm-12">
  <mat-form-field class="w-100" appearance="legacy">
    <mat-label>Selezionare Stato estero di residenza </mat-label>
    <mat-select formControlName="statoResidenza">
      <mat-option>-- None --</mat-option>
      <mat-option *ngFor="let stato of statiEsteriList" [value]="stato.codStato!.toString()">{{stato.decrizioneStato}}</mat-option>
    </mat-select>
    <mat-error>
      <app-control-messages [control]="residenzaEstera.controls['statoResidenza']"></app-control-messages>
    </mat-error>
  </mat-form-field>
</div>
<!-- Citta -->
<div class="col-md-6 col-sm-12">
  <mat-form-field class="w-100" appearance="legacy">
    <mat-label>Citta di residenza</mat-label>
    <input matInput formControlName="cittaResidenza" maxlength="100" style="text-transform:uppercase">
    <mat-error>
      <app-control-messages [control]="residenzaEstera.controls['cittaResidenza']"></app-control-messages>
    </mat-error>
  </mat-form-field>
</div>
</form>
</ng-template>



<!-- ---------------------------------------------------------------------------- -->
<!-- ---------------------------Domicilio--------------------------------------- -->
<hr>
<h5 mat-dialog-title>Domicilio</h5>
<mat-card-subtitle>(compilare solo se diverso da residenza)</mat-card-subtitle>
<div class="row">
  <!-- Provincia -->
  <div class="col-md-6 col-sm-12">
    <mat-form-field class="w-100" appearance="legacy">
      <mat-label>Selezionare Provincia del domicilio </mat-label>
      <mat-select formControlName="provinciaDomicilio" (selectionChange)="fetchComuniDomicilio(form.controls['provinciaDomicilio'].value!)">
        <mat-option>-- None --</mat-option>
        <mat-option *ngFor="let provincia of provincieList" [value]="provincia.codiceProvincia">{{provincia.descrizione}}</mat-option>
      </mat-select>
    </mat-form-field>
  </div>
  <!-- Comune -->
  <div class="col-md-6 col-sm-12">
    <mat-form-field class="w-100" appearance="legacy">
      <mat-label>Selezionare Comune del domicilio</mat-label>
      <mat-select formControlName="comuneDomicilio">
        <mat-option>-- None --</mat-option>
        <mat-option *ngFor="let comune of comuniDomicilioList" [value]="comune.codiceIstatComune">{{comune.descrizione}}</mat-option>
      </mat-select>
    </mat-form-field>
  </div>
  <!-- Indirizzo -->
  <div class="col-10">
    <mat-form-field class="w-100" appearance="legacy">
      <mat-label>Indirizzo</mat-label>
      <input matInput formControlName="indirizzoDomicilio" maxlength="100" style="text-transform:uppercase">
    </mat-form-field>
  </div>
  <!-- Cap -->
  <div class="col-2">
    <mat-form-field class="w-100" appearance="legacy">
      <mat-label>CAP</mat-label>
      <input matInput formControlName="capDomicilio" [textMask]="{mask:capMask, guide:false}">
      <mat-error>
        <app-control-messages [control]="form.controls['capDomicilio']"></app-control-messages>
      </mat-error>
    </mat-form-field>
  </div>
</div>




<!-- ---------------------------------------------------------------------------- -->
<!-- ---------------------------Recapiti--------------------------------------- -->
<hr>
<h5 mat-dialog-title>Recapiti</h5>

<div class="row">

<!-- Telefono -->
<div class="col-md-6 col-sm-12">
  <mat-form-field class="w-100" appearance="legacy">
    <mat-label>Telefono</mat-label>
    <input matInput formControlName="telefono" maxlength="50">
    <mat-error>
      <app-control-messages [control]="form.controls['telefono']"></app-control-messages>
    </mat-error>
  </mat-form-field>
</div>
<!-- Email -->
<div class="col-md-6 col-sm-12">
  <mat-form-field class="w-100" appearance="legacy">
    <mat-label>Email</mat-label>
    <input matInput formControlName="email" maxlength="100">
    <mat-error>
      <app-control-messages [control]="form.controls['email']"></app-control-messages>
    </mat-error>
  </mat-form-field>
</div>
</div>

</form>
</div>
</mat-dialog-content>

<mat-divider></mat-divider>
<mat-dialog-actions  [align]="'end'" class="d-flex justify-content-between">
  <button *ngIf="soloView"
        class="btn btn--outline-primary"
        mat-dialog-close
        >CHIUDI</button>
  <button *ngIf="!soloView"
          class="btn btn--outline-primary"
          mat-dialog-close=""
          >ANNULLA</button>
  <button *ngIf="!soloView"
          class="btn btn--primary"
          aria-label="conferma salvataggio dati destinatario"
          (click)="onConferma(scrollContainer)">Conferma</button>

</mat-dialog-actions>

